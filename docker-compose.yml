services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: job-app
    restart: always
    working_dir: /var/www
    volumes:
      - ./:/var/www
      - ./storage:/var/www/storage
      - ./bootstrap/cache:/var/www/bootstrap/cache
    ports:
      - '8001:8001'
      - '5174:5174'
    environment:
      DB_CONNECTION: mariadb
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: jobboard_db
      DB_USERNAME: root
      DB_PASSWORD: ''
      GEMINI_API_KEY: AIzaSyAc-CYSilLFdvFBMfRcNaNycqzjB7QMuzg
      SUPABASE_ACCESS_KEY_ID: be439d1813638ac8acd4a4733c4b3c08
      SUPABASE_SECRET_ACCESS_KEY: 385e3d111ea5de8926872d13124481a1685faac40eb7f4ece135c33103209cb6
      SUPABASE_REGION: eu-north-1
      SUPABASE_BUCKET: ShaghalniResumes
      SUPABASE_ENDPOINT: https://rybxfrlqueuyunigopty.storage.supabase.co/storage/v1/s3
    networks:
      - jobboard-network
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -e
        echo 'ğŸ”§ Waiting for files to sync...'
        sleep 2
        
        echo 'ğŸ” Checking if job-backoffice database is accessible...'
        until php -r "new PDO('mysql:host=db;port=3306', 'root', '');" 2>/dev/null; do
          echo 'â³ Waiting for database...'
          sleep 2
        done
        echo 'âœ… Database is accessible!'
        
        echo 'ğŸ”§ Fixing permissions...'
        chown -R www-data:www-data /var/www || true
        chmod -R 775 /var/www/storage /var/www/bootstrap/cache || true
        
        echo 'â³ Installing Composer dependencies...'
        composer install --no-interaction --prefer-dist --optimize-autoloader --no-cache
        
        echo 'â³ Installing NPM dependencies... (this may take 2-3 minutes)'
        npm ci --prefer-offline --no-audit
        
        echo 'âœ… NPM install completed!'
        
        echo 'â³ Setting up environment...'
        test -f .env || cp .env.example .env
        php artisan key:generate --force
        
        echo 'âœ… Setup complete!'
        
        echo 'ğŸš€ Starting Laravel server on port 8001...'
        php artisan serve --host=0.0.0.0 --port=8001 &
        
        echo 'â³ Waiting for Laravel to start...'
        sleep 5
        
        echo 'ğŸ¨ Starting Vite dev server on port 5174...'
        npm run dev -- --host

networks:
  jobboard-network:
    external: true
    name: jobboard-network